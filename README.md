# Composite Microservice

This repository contains a **composite microservice** that orchestrates three separate atomic microservices:

1. **Walk Service** (Port 8000) - FastAPI service managing dog walk requests
   - Location: External (e.g., `../Walk-Service-main/`)
   - Standalone atomic microservice

2. **User Service** (Port 3001) - Express.js service managing users and dogs
   - Location: External (e.g., `../Cloud-Computing-Database-xuanming/user-service/`)
   - Standalone atomic microservice

3. **Review Service** (Port 8001) - FastAPI service managing reviews and ratings
   - Location: External (e.g., `../PawPal-Review-main/`)
   - Standalone atomic microservice

**This composite service** (Port 8002) encapsulates and orchestrates all three atomic services, providing:
- Unified API that delegates to all three services
- Foreign key constraint validation across services
- Parallel execution for improved performance
- Aggregated endpoints that combine data from multiple services

---

## ğŸš€ Features

- âœ… **Encapsulates atomic microservices** - All APIs from Walk, User, and Review services are exposed
- âœ… **Delegates to atomic services** - All operations are delegated to the appropriate atomic microservice
- âœ… **Parallel execution** - Uses `ThreadPoolExecutor` in service layer (separated from HTTP handlers)
- âœ… **Foreign key constraints** - Validates logical foreign key relationships (e.g., reviews must reference existing walks and users)
- âœ… **OpenAPI documentation** - Auto-generated by FastAPI at `/docs`
- âœ… **Clean architecture** - Service layer separates business logic from HTTP handling
- âœ… **No model duplication** - Uses shared models, treats atomic services as black boxes

---

## ğŸ“ Project Structure

```
.
â”œâ”€â”€ pawpal-composite-service/    # Main composite microservice
â”‚   â”œâ”€â”€ main.py                  # FastAPI application (route handlers)
â”‚   â”œâ”€â”€ constraints.py           # Foreign key constraint validation
â”‚   â”œâ”€â”€ requirements.txt         # Python dependencies
â”‚   â”œâ”€â”€ services/                # Service layer (business logic)
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ orchestration.py    # Parallel execution logic (ThreadPoolExecutor)
â”‚   â””â”€â”€ clients/                # HTTP clients for atomic services
â”‚       â”œâ”€â”€ walk_client.py
â”‚       â”œâ”€â”€ review_client.py
â”‚       â””â”€â”€ user_client.py
â”œâ”€â”€ models/                      # Shared models (used by composite service)
â”‚   â”œâ”€â”€ walk.py
â”‚   â”œâ”€â”€ user.py
â”‚   â””â”€â”€ review.py
â”œâ”€â”€ FIXES_APPLIED.md            # Documentation of architectural improvements
â””â”€â”€ REQUIREMENTS_ASSESSMENT.md  # Requirements verification
```

**Key Design Principles**:
- **No model duplication**: Composite service imports models from parent directory
- **Service layer separation**: Threading logic in `services/orchestration.py`, not in route handlers
- **Clear boundaries**: Composite treats atomic services as black boxes

---

## ğŸ Quick Start

### Prerequisites

- Python 3.8+
- **All three atomic microservices must be running:**
  - Walk Service (default: `http://localhost:8000`)
  - Review Service (default: `http://localhost:8001`)
  - User Service (default: `http://localhost:3001`)

**See `pawpal-composite-service/SETUP_GUIDE.md` for detailed instructions on starting all services.**

### Installation

1. **Navigate to composite service directory**:
```bash
cd pawpal-composite-service
```

2. **Install dependencies**:
```bash
pip install -r requirements.txt
```

3. **Set environment variables** (optional):
```bash
export WALK_SERVICE_URL=http://localhost:8000
export REVIEW_SERVICE_URL=http://localhost:8001
export USER_SERVICE_URL=http://localhost:3001
export COMPOSITE_PORT=8002
```

4. **Start the composite service**:
```bash
uvicorn main:app --reload --port 8002
```

5. **Access API documentation**:
```
http://localhost:8002/docs
```

---

## ğŸ“˜ API Endpoints

### Walk Endpoints (Delegated)

- `POST /walks` - Create a walk
- `GET /walks` - List walks (with filters: owner_id, city, status)
- `GET /walks/{walk_id}` - Get a walk
- `PATCH /walks/{walk_id}` - Update a walk
- `DELETE /walks/{walk_id}` - Delete a walk

### Review Endpoints (Delegated with FK Validation)

- `POST /reviews` - Create a review (validates walkId, ownerId, walkerId exist)
- `GET /reviews` - List reviews (with filters: walkerId, ownerId, walkId, minRating, maxRating)
- `GET /reviews/{review_id}` - Get a review
- `PATCH /reviews/{review_id}` - Update a review
- `DELETE /reviews/{review_id}` - Delete a review

### User Endpoints (Delegated)

- `GET /users` - List users (with filters: role, location)
- `GET /users/{user_id}` - Get a user
- `GET /users/{user_id}/dogs` - Get dogs for a user

### Orchestrated Endpoints (Composite Operations with Parallel Execution)

These endpoints demonstrate thread-based parallel execution via the orchestration service:

- `GET /walks/{walk_id}/complete` - Get walk with reviews (parallel execution)
- `GET /users/{user_id}/complete` - Get user with dogs and reviews (parallel execution)

---

## ğŸ”— Foreign Key Constraints

The composite service enforces logical foreign key constraints:

1. **Review Creation**:
   - `walkId` must exist in Walk service
   - `ownerId` must exist in User service
   - `walkerId` must exist in User service

If any constraint is violated, a `400 Bad Request` error is returned with details.

---

## âš¡ Parallel Execution

Parallel execution is implemented in the **service layer** (`pawpal-composite-service/services/orchestration.py`), separating threading logic from HTTP handlers. This follows Sprint 0 best practices for separation of concerns.

The following endpoints use thread-based parallel execution via the orchestration service:

1. **`GET /walks/{walk_id}/complete`**:
   - Fetches walk and reviews in parallel using `ThreadPoolExecutor`

2. **`GET /users/{user_id}/complete`**:
   - Fetches user, dogs, and reviews (as owner and walker) in parallel using 3 threads

**Architecture**: Route handlers â†’ Orchestration Service â†’ ThreadPoolExecutor

---

## ğŸ“ Example Usage

### Create a Review (with FK validation)

```bash
curl -X POST http://localhost:8002/reviews \
  -H "Content-Type: application/json" \
  -d '{
    "walkId": "11111111-1111-4111-8111-111111111111",
    "ownerId": "user-123",
    "walkerId": "user-456",
    "rating": 4.5,
    "comment": "Great walk!"
  }'
```

### Get Complete Walk Information (parallel execution)

```bash
curl http://localhost:8002/walks/11111111-1111-4111-8111-111111111111/complete
```

### Get Complete User Information (parallel execution)

```bash
curl http://localhost:8002/users/user-123/complete
```

---

## ğŸ¯ Requirements Satisfied

âœ… **Composite Microservice**: Encapsulates and exposes three atomic microservice APIs  
âœ… **Delegation**: All operations delegate to the atomic services via HTTP  
âœ… **Parallel Execution**: Uses threads for concurrent operations (`ThreadPoolExecutor` in service layer)  
âœ… **Foreign Key Constraints**: Enforces logical FK constraints at composite layer  
âœ… **Orchestration**: Provides higher-level endpoints that coordinate multiple operations  
âœ… **Clean Architecture**: Service layer separates business logic from HTTP handling  
âœ… **No Model Duplication**: Uses shared models, treats atomic services as black boxes

---

## ğŸ“š Additional Documentation

- **Setup Guide**: See `pawpal-composite-service/SETUP_GUIDE.md` for detailed setup instructions
- **Architecture**: See `pawpal-composite-service/ARCHITECTURE.md` for architecture details
- **Requirements Verification**: See `pawpal-composite-service/REQUIREMENTS_VERIFICATION.md` for requirements checklist
- **Fixes Applied**: See `FIXES_APPLIED.md` for documentation of architectural improvements

---

## ğŸ”§ Error Handling

- **404 Not Found**: Resource doesn't exist
- **400 Bad Request**: Foreign key constraint violation or invalid input
- **503 Service Unavailable**: Atomic service not initialized or unavailable

---

## ğŸ“„ License

This project is part of a microservices architecture demonstration.
