# PawPal Composite Microservice

This composite microservice **orchestrates three separate atomic microservices**:

1. **Walk Service** (Port 8000) - FastAPI service managing dog walk requests
   - Location: `../Walk-Service-main/`
   - Standalone atomic microservice

2. **User Service** (Port 3001) - Express.js service managing users and dogs
   - Location: `../Cloud-Computing-Database-xuanming/user-service/`
   - Standalone atomic microservice

3. **Review Service** (Port 8001) - FastAPI service managing reviews and ratings
   - Location: `../PawPal-Review-main/`
   - Standalone atomic microservice

**This composite service** (Port 8002) encapsulates and orchestrates all three atomic services, providing:
- Unified API that delegates to all three services
- Foreign key constraint validation across services
- Parallel execution for improved performance
- Aggregated endpoints that combine data from multiple services

## Features

- ✅ **Encapsulates atomic microservices** - All APIs from Walk, User, and Review services are exposed
- ✅ **Delegates to atomic services** - All operations are delegated to the appropriate atomic microservice
- ✅ **Parallel execution** - Uses `ThreadPoolExecutor` for concurrent operations in multiple endpoints
- ✅ **Foreign key constraints** - Validates logical foreign key relationships (e.g., reviews must reference existing walks and users)
- ✅ **OpenAPI documentation** - Auto-generated by FastAPI at `/docs`
- ✅ **Pydantic models** - Type-safe models for all data structures

## Quick Start

### Prerequisites

- Python 3.8+
- Node.js 16+ (for User Service)
- MySQL 8.0+ (for User and Review services)
- **All three atomic microservices must be running:**
  - Walk Service (default: `http://localhost:8000`) - See `../Walk-Service-main/`
  - Review Service (default: `http://localhost:8001`) - See `../PawPal-Review-main/`
  - User Service (default: `http://localhost:3001`) - See `../Cloud-Computing-Database-xuanming/user-service/`

**See `SETUP_GUIDE.md` for detailed instructions on starting all services.**

### Installation

1. **Install dependencies**:
```bash
pip install -r requirements.txt
```

2. **Set environment variables** (optional):
```bash
export WALK_SERVICE_URL=http://localhost:8000
export REVIEW_SERVICE_URL=http://localhost:8001
export USER_SERVICE_URL=http://localhost:3001
export COMPOSITE_PORT=8002
```

3. **Start the service**:
```bash
uvicorn main:app --reload --port 8002
```

4. **Access API documentation**:
```
http://localhost:8002/docs
```

## API Endpoints

### Walk Endpoints (Delegated)

- `POST /walks` - Create a walk
- `GET /walks` - List walks (with filters: owner_id, city, status)
- `GET /walks/{walk_id}` - Get a walk
- `PATCH /walks/{walk_id}` - Update a walk
- `DELETE /walks/{walk_id}` - Delete a walk

### Review Endpoints (Delegated with FK Validation)

- `POST /reviews` - Create a review (validates walkId, ownerId, walkerId exist)
- `GET /reviews` - List reviews (with filters: walkerId, ownerId, walkId, minRating, maxRating)
- `GET /reviews/{review_id}` - Get a review
- `PATCH /reviews/{review_id}` - Update a review
- `DELETE /reviews/{review_id}` - Delete a review

### User Endpoints (Delegated)

- `GET /users` - List users (with filters: role, location)
- `GET /users/{user_id}` - Get a user
- `GET /users/{user_id}/dogs` - Get dogs for a user

### Orchestrated Endpoints (Composite Operations with Parallel Execution)

- `GET /walks/{walk_id}/complete` - Get walk with reviews (parallel execution)
- `GET /users/{user_id}/complete` - Get user with dogs and reviews (parallel execution)
- `GET /reviews/{review_id}/complete` - Get review with walk, owner, and walker (parallel execution)

## Foreign Key Constraints

The composite service enforces logical foreign key constraints:

1. **Review Creation**:
   - `walkId` must exist in Walk service
   - `ownerId` must exist in User service
   - `walkerId` must exist in User service

If any constraint is violated, a `400 Bad Request` error is returned with details.

## Parallel Execution

The following endpoints use `ThreadPoolExecutor` for parallel execution:

1. **`GET /walks/{walk_id}/complete`**:
   - Fetches walk and reviews in parallel

2. **`GET /users/{user_id}/complete`**:
   - Fetches user, dogs, and reviews (as owner and walker) in parallel using 3 threads

3. **`GET /reviews/{review_id}/complete`**:
   - Fetches review, walk, owner, and walker in parallel using 3 threads

## Example Usage

### Create a Review (with FK validation)

```bash
curl -X POST http://localhost:8002/reviews \
  -H "Content-Type: application/json" \
  -d '{
    "walkId": "11111111-1111-4111-8111-111111111111",
    "ownerId": "user-123",
    "walkerId": "user-456",
    "rating": 4.5,
    "comment": "Great walk!"
  }'
```

### Get Complete Walk Information (parallel execution)

```bash
curl http://localhost:8002/walks/11111111-1111-4111-8111-111111111111/complete
```

### Get Complete User Information (parallel execution)

```bash
curl http://localhost:8002/users/user-123/complete
```

## Project Structure

```
pawpal-composite-service/
├── main.py                 # FastAPI application
├── constraints.py          # Foreign key constraint validation
├── requirements.txt        # Python dependencies
├── README.md              # This file
├── models/                # Pydantic models
│   ├── __init__.py
│   ├── walk.py
│   ├── review.py
│   └── user.py
└── clients/               # HTTP clients for atomic services
    ├── __init__.py
    ├── walk_client.py
    ├── review_client.py
    └── user_client.py
```

## OpenAPI Documentation

FastAPI automatically generates OpenAPI documentation. Access it at:
- Swagger UI: `http://localhost:8002/docs`
- ReDoc: `http://localhost:8002/redoc`
- OpenAPI JSON: `http://localhost:8002/openapi.json`

## Error Handling

- **404 Not Found**: Resource doesn't exist
- **400 Bad Request**: Foreign key constraint violation or invalid input
- **503 Service Unavailable**: Atomic service not initialized or unavailable


